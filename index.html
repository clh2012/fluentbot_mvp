<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FluentBot - Spanish Conversation</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      max-width: 600px;
      margin: auto;
    }
    button {
      font-size: 1em;
      padding: 0.5em 1em;
      margin-top: 1em;
    }
    #chat {
      margin-top: 2em;
      background: #f9f9f9;
      padding: 1em;
      border-radius: 8px;
      height: 300px;
      overflow-y: auto;
    }
    .message {
      margin-bottom: 1em;
    }
    .user {
      text-align: right;
      font-weight: bold;
      color: #0070f3;
    }
    .assistant {
      text-align: left;
      color: #333;
    }
    #textInput {
      width: 100%;
      font-size: 1em;
      padding: 0.5em;
      margin-top: 1em;
    }
  </style>
</head>
<body>
  <h1>üé§ Speak or Type to Your Spanish Partner</h1>

  <button id="recordBtn">üéôÔ∏è Start Recording</button>
  <input type="text" id="textInput" placeholder="Or type your message in Spanish..." />

  <div id="chat"></div>

  <script>
    const recordBtn = document.getElementById('recordBtn');
    const textInput = document.getElementById('textInput');
    const chatDiv = document.getElementById('chat');

    let mediaRecorder;
    let audioChunks = [];

    // Voice recording
    recordBtn.addEventListener('click', async () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        recordBtn.textContent = 'üéôÔ∏è Start Recording';
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        audioChunks = [];
        const audioBase64 = await blobToBase64(audioBlob);
        await sendToChat({ audioBase64 });
      };

      mediaRecorder.start();
      recordBtn.textContent = '‚èπÔ∏è Stop Recording';
    });

    // Text input
    textInput.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter' && textInput.value.trim()) {
        const message = textInput.value.trim();
        textInput.value = '';
        await sendToChat({ message });
      }
    });

    async function sendToChat(body) {
      if (body.message) addMessage(body.message, 'user');

      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const data = await res.json();

      if (data.reply) {
        addMessage(data.reply, 'assistant');

        const audioReplyBlob = new Blob(
          [Uint8Array.from(atob(data.audioBase64), c => c.charCodeAt(0))],
          { type: 'audio/mpeg' }
        );
        const audioUrl = URL.createObjectURL(audioReplyBlob);
        const audio = new Audio(audioUrl);
        audio.play();
      } else {
        addMessage("‚ö†Ô∏è Error: No reply received", 'assistant');
      }
    }

    function addMessage(text, role) {
      const msg = document.createElement('div');
      msg.className = 'message ' + role;
      msg.textContent = text;
      chatDiv.appendChild(msg);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
  </script>
<script>
  async function sendToChat(body) {
    if (body.message) addMessage(body.message, 'user');

    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const data = await res.json();

    if (data.reply) {
      addMessage(data.reply, 'assistant');

      const audioReplyBlob = new Blob(
        [Uint8Array.from(atob(data.audioBase64), c => c.charCodeAt(0))],
        { type: 'audio/mpeg' }
      );
      const audioUrl = URL.createObjectURL(audioReplyBlob);
      const audio = new Audio(audioUrl);
      audio.play();
    } else {
      addMessage("‚ö†Ô∏è Error: No reply received", 'assistant');
    }
  }
</script>

</body>
</html>
