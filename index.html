<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FluentBot - Spanish Conversation</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; }
    button { font-size: 1.2em; padding: 0.5em 1em; margin-top: 1em; }
    #transcript, #reply { margin-top: 1em; font-size: 1.2em; }
  </style>
</head>
<body>
  <h1>ðŸŽ¤ Talk to Your Spanish Partner</h1>

  <button id="recordBtn">Start Recording</button>

  <div id="transcript"></div>
  <div id="reply"></div>

  <script>
    const recordBtn = document.getElementById('recordBtn');
    const transcriptDiv = document.getElementById('transcript');
    const replyDiv = document.getElementById('reply');

    let mediaRecorder;
    let audioChunks = [];

    recordBtn.addEventListener('click', async () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        recordBtn.textContent = 'Start Recording';
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        audioChunks = [];

        const audioBase64 = await blobToBase64(audioBlob);

        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ audioBase64 })
        });

        const data = await res.json();

        if (data.reply) {
          transcriptDiv.textContent = 'You said: ' + data.reply;
          replyDiv.textContent = 'Partner: ' + data.reply;

          const audioReplyBlob = new Blob(
            [Uint8Array.from(atob(data.audioBase64), c => c.charCodeAt(0))],
            { type: 'audio/mpeg' }
          );
          const audioUrl = URL.createObjectURL(audioReplyBlob);
          const audio = new Audio(audioUrl);
          audio.play();
        } else {
          replyDiv.textContent = 'Error: No reply received';
        }
      };

      mediaRecorder.start();
      recordBtn.textContent = 'Stop Recording';
    });

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>
